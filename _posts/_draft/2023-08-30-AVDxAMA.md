---
layout: post
title:  "Next-Level AVD Insights: Leveraging Azure Monitor Agent's Advanced Capabilities"
date:   2023-08-31 15:00:00 +0100
categories: AVD
tags: [AVD,Azure Monitor,Azure]
---
# Next-Level AVD Insights: Leveraging Azure Monitor Agent's Advanced Capabilities

![This image shows the AVDPunk Header](/assets/img/2023-08-31/2023-08-31-header.png)

## Table of contents
1. [Introduction](#Introduction)
2. [Understanding the Function of Azure Monitor Agent](#Understanding-the-Function-of-Azure-Monitor-Agent)
3. [Enabling AVD Insight (Preview) Using Azure Monitor Agent](#Enabling-AVD-Insight-Preview-Using-Azure-Monitor-Agent)
4. [Provisioning AVD Session Hosts with Azure Monitor Agent via ARM Template](#Provisioning-AVD-Session-Hosts-with-Azure-Monitor-Agent-via-ARM-Template)
5. [Validating Azure Monitor Data for AVD Insights](#Validating-Azure-Monitor-Data-for-AVD-Insights)
6. [Conclusion](#Conclusion)

## Introduction

The current AVD Insights are based on Azure Log Analytics workspaces that use multiple agents such as Monitoring Dependency Agent or Microsoft Monitoring Agent (MMA) to collect monitoring data from session hosts. 

AVD Insights visualizes these log entries and performance data in charts and tables. The idea behind it is to improve troubleshooting to solve problems faster and get a complete overview of the entire AVD environment. You can also create some report exports to discuss usage with the management level. 

Two years ago, on 19 August 2021, we announced we were retiring the Log Analytics Agent (MMA & Co) to simplify everything to one agent, the Azure Monitor Agent (AMA). Because of this, we need to move all virtual machines to Azure Monitor Agent by 31 August 2024, which includes Azure Virtual Desktop Session Hosts and AVD Insights.

Here is the [official announcement:](https://azure.microsoft.com/en-us/updates/were-retiring-the-log-analytics-agent-in-azure-monitor-on-31-august-2024/)

*"On 31 August 2024, we'll retire the Log Analytics agent that you use in Azure Monitor.â€¯Before that date, you'll need to start using the Azure Monitor agent to monitor your VMs and servers in Azure."* 

With only one monitoring agent, we want to eliminate confusion about which agent is responsible for which mission.

This change also affects AVD insights, and we need to migrate existing AVD session hosts to use the Azure Monitor agent, and new session hosts we should enable to use the new agent directly. 

This blog post does not describe how to migrate from the legacy agent to the Azure Monitor agent, but how to enable AVD Insight with AMA. Please follow the [migrate guide](https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-migration).

Here is the official announcement of the public preview for [AVD Insight powered by Azure Monitor Agent.](https://azure.microsoft.com/en-us/updates/public-preview-azure-virtual-desktop-insights-powered-by-the-azure-monitor-agent/) 

## Understanding the Function of Azure Monitor Agent

Azure Monitor Agent serves as a bridge between AVD deployments and Azure Monitor, enabling administrators to gain real-time insights into the performance and health of their virtual desktop environments. By collecting essential telemetry data from AVD infrastructure and session hosts, the agent facilitates informed decision-making, proactive issue resolution, and overall optimization.

Azure Monitor Agent uses data collection rules that allow you to specify the specific data you want each agent to collect. These rules allow you to comprehensively manage data collection settings and create different, customized configurations for specific groups of machines. It is possible to specify rules that route data from numerous machines to multiple destinations across regions and tenants.

![This image shows Azure Monitor with AVD](/assets/img/2023-08-31/2023-08-31-100.png)

Regarding AVD, it will gather Windows Event Logs, such as FSLogix logs, along with Performance Counters like Processor Information, Memory, or Terminal Services.

If you want to understand the differences between Azure Monitor Agent and Legacy Agents, please follow this link: [Compare to legacy agents](https://learn.microsoft.com/en-us/azure/azure-monitor/agents/agents-overview#compare-to-legacy-agents)

For more information about the AMA, please visit [here.](https://learn.microsoft.com/enpower-us/azure/azure-monitor/agents/agents-overview)

## Enabling AVD Insights (Preview) Using Azure Monitor Agent

### Requirements

AVD Insights (Preview) with Azure Monitor Agent has the same requirements as the previous version of AVD Insight, which means you need a Log Analytics Workspace to collect all log entries and performance counters.

You can use the following PowerShell commands to create a new Log Analytics workspace:
```
$ResourceGroup = "YourResourceGroupName"
$WorkspaceName = "YourLogAnalyticsWorkspaceName"
$Location = "YourRegion"
New-AzOperationalInsightsWorkspace -Location $Location -Name $WorkspaceName -ResourceGroupName $ResourceGroup
```
Otherwise, you can follow the [Microsoft documentation to create Log Analytics workspace in the Azure Portal](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal).

### How to enable AVD Insight (Preview)


![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-000.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-001.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-002.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-003.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-004.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-005.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-006.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-007.png)

![This image shows the deallocation workflow](/assets/img/2023-08-31/2023-08-31-008.png)



https://learn.microsoft.com/en-us/azure/virtual-desktop/insights?tabs=monitor

https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/data-collection-rule-overview

### Limitations

- Static Resource Group

## Provisioning AVD Session Hosts with Azure Monitor Agent via ARM Template

https://learn.microsoft.com/en-us/azure/azure-monitor/agents/resource-manager-data-collection-rules?tabs=json#create-association-with-azure-vm

```
{
	"type": "Microsoft.Insights/dataCollectionRuleAssociations",
	"apiVersion": "2021-09-01-preview",
    "name": "AzureMonitorDataCollectionRuleAssociations",
    "scope": "[format('Microsoft.Compute/virtualMachines/{0}', concat(parameters('rdshNamePrefix'), parameters('vmNumber')))]",
    "dependsOn": [
        "Your-Previous-Task"
    ],
	"properties": {
        "description": "Association of data collection rule. Deleting this association will break the data collection for this virtual machine.",
        "dataCollectionRuleId": "[parameters('dataCollectionRuleId')]"
        }
}
```




## Validating Azure Monitor Data for AVD Insights




## Conclusion
